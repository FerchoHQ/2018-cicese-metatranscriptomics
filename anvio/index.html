



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://bluegenes.github.io/2018-metatranscriptomics/anvio/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="..">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.3">
    
    
      
        <title>Using Anvi'o to Knit Everything Together - 2018 CICESE Metatranscriptomics workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#using-anvio-to-knit-everything-together" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://bluegenes.github.io/2018-metatranscriptomics" title="2018 CICESE Metatranscriptomics workshop" class="md-header-nav__button md-logo">
          
            <i class="md-icon">dns</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                2018 CICESE Metatranscriptomics workshop
              </span>
              <span class="md-header-nav__topic">
                Using Anvi'o to Knit Everything Together
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/bluegenes/2018-metatranscriptomics-workshop-dev" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      2018-metatranscriptomics-workshop-dev
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://bluegenes.github.io/2018-metatranscriptomics" title="2018 CICESE Metatranscriptomics workshop" class="md-nav__button md-logo">
      
        <i class="md-icon">dns</i>
      
    </a>
    2018 CICESE Metatranscriptomics workshop
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/bluegenes/2018-metatranscriptomics-workshop-dev" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      2018-metatranscriptomics-workshop-dev
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../code-of-conduct/" title="Code of Conduct" class="md-nav__link">
      Code of Conduct
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../working-with-bioconda/" title="Bioconda" class="md-nav__link">
      Bioconda
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../count_transcriptomes/" title="Count Transcriptomes" class="md-nav__link">
      Count Transcriptomes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing-anvio-and-a-few-other-programs" title="Installing anvi'o (and a few other programs)" class="md-nav__link">
    Installing anvi'o (and a few other programs)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-it-into-anvio-format" title="Getting it into Anvi'o format" class="md-nav__link">
    Getting it into Anvi'o format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mapping-data" title="Mapping data" class="md-nav__link">
    Mapping data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-contigs-database" title="Generating contigs database" class="md-nav__link">
    Generating contigs database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-and-refining-genome-bins" title="Identifying and refining genome bins" class="md-nav__link">
    Identifying and refining genome bins
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="using-anvio-to-knit-everything-together">Using Anvi'o to Knit Everything Together</h1>
<p>Now we are going bring it all together and visuzlize our assembly with <a href="http://merenlab.org/software/anvio/">Anvi'o</a>. Anvi'o is a powerful and extensible tool that might be easily applied to pan-genomic analysis as well as metagenomic analysis. The anvi'o group has a series of fantstic online tutorials, including one on <a href="http://merenlab.org/2016/06/22/anvio-tutorial-v2/">metagenomic analysis</a>. They also run workshops periodically (<a href="http://merenlab.org/2016/08/18/events/">schedule here</a>) that throughly cover the use of the software.</p>
<p>Today, we are adapting their tutorial on metagenomic analysis to work with the subset dataset that we have.</p>
<p>The goals of this tutorial are to:
<em> Install anvi'o
</em> Become familiar with the anvi'o workflow
<em> Visualizing the assembly with anvi'o
</em> Become familiar with the anvi'o interface
* Learn how to refine and visuzlize genome bins with anvi'o</p>
<h2 id="installing-anvio-and-a-few-other-programs">Installing anvi'o (and a few other programs)</h2>
<p>The first thing we need to do is install anvi'o. To install anvi'o we will be be using <a href="https://www.continuum.io/what-is-anaconda">Anaconda</a>.</p>
<pre><code>cd ~
wget https://repo.continuum.io/archive/Anaconda3-4.4.0-Linux-x86_64.sh
bash Anaconda3-4.4.0-Linux-x86_64.sh
</code></pre>

<p>Now, follow the prompts for the Anaconda installation. To finish the install it will ask you if you would like to add anaconda to the <code>$PATH</code> in you <code>.bashrc</code>. You should say yes. Now, you just need to source your <code>.bashrc</code> to make sure you can use conda.</p>
<pre><code>source .bashrc
</code></pre>

<p>Anaconda should now be installed. We will now use anaconda (<code>conda</code>) to install anvi'o (and all its dependencies) as well as source an environment in which to to run conda.</p>
<p>Now, install anvi'o using conda, create an environment in which to run it, and source the environment:</p>
<pre><code>conda create -n anvio232 -c bioconda -c conda-forge gsl anvio=2.3.2
source activate anvio232
</code></pre>

<p>Anvi'o should now be installed. But, let's double check that it worked. They have a nice little test case to check that everything is working well as follows:</p>
<pre><code>anvi-self-test --suite mini
</code></pre>

<p>This prompt will start anvi'o processing and ultimately it will generate an interactive window with the anvi'o environment. This is accessible through port 8080 (typically, though it might create go to a different port that will be specified) at your ec2 machine address.</p>
<p>Now, open a new tab in your browser (NOTE: This only works in Google Chrome) and paste in the following:</p>
<pre><code>[Your EC Address]:8080
</code></pre>

<p>This should open up the anvi'o interface which is interactive and pretty good looking.</p>
<p>Now, we just need to install a few other programs, namely, samtools and Bowtie2, which we will use for mapping and looking at our mapped data.</p>
<pre><code>wget https://downloads.sourceforge.net/project/bowtie-bio/bowtie2/2.3.2/bowtie2-2.3.2-linux-x86_64.zip
unzip bowtie2-2.3.2-linux-x86_64.zip

echo 'export PATH=$PATH:~/bowtie2-2.3.2' &gt;&gt; ~/.bashrc
source ~/.bashrc
sudo apt-get -y install samtools
</code></pre>

<p>Alright, now onto a complete re-analysis of our data with the anvi'o pipeline.</p>
<h2 id="getting-it-into-anvio-format">Getting it into Anvi'o format</h2>
<p>Anvi'o takes in 1) an assembly and 2) the raw read data. We have both of those already created, so let's go ahead and download those data (trimmed reads and asssemblies):</p>
<pre><code>mkdir ~/anvio-work
cd ~/anvio-work

curl -O https://s3-us-west-1.amazonaws.com/dib-training.ucdavis.edu/metagenomics-scripps-2016-10-12/SRR1976948.abundtrim.subset.pe.fq.gz
curl -O https://s3-us-west-1.amazonaws.com/dib-training.ucdavis.edu/metagenomics-scripps-2016-10-12/SRR1977249.abundtrim.subset.pe.fq.gz
curl -O https://s3-us-west-1.amazonaws.com/dib-training.ucdavis.edu/metagenomics-scripps-2016-10-12/subset_assembly.fa.gz

</code></pre>

<p>And, gunzip those files:</p>
<pre><code>for file in *gz
    do
    gunzip $file
done
</code></pre>

<p>We now need to get our assembly into the correct format so that anvi'o interpret it.</p>
<pre><code>anvi-script-reformat-fasta subset_assembly.fa -o anvio-contigs.fa --min-len 2000 --simplify-names --report name_conversions.txt
</code></pre>

<p>Take a look at the output files. What has changed?</p>
<h2 id="mapping-data">Mapping data</h2>
<p>We need to map our reads to our anvi'o corrected assembly. This is going to take a little bit of time. First, build the an index for bowtie2:</p>
<pre><code>bowtie2-build anvio-contigs.fa anvio-contigs
</code></pre>

<p>We can write a for loop to map our two datasets and produce .bam files for the files:</p>
<pre><code>for file in *fq
do
    bowtie2 --threads 8 -x anvio-contigs --interleaved $file -S ${file/.fq/}.sam
    samtools view -U 4 -bS ${file/.fq/}.sam &gt; ${file/.fq/}.bam
done
</code></pre>

<p>As above, we need to make these data readable for anvi'o:</p>
<pre><code>for file in *.bam
do
    anvi-init-bam ${file} -o ${file/.bam/}.anvio.bam
done

</code></pre>

<h2 id="generating-contigs-database">Generating contigs database</h2>
<p>In this step we are asking anvi'o to create a database with information about your contigs. The contig database is fairly extensible and can contain lots of different information (taxonomic, functional, etc.). Here, we are primarily asking it to do three things:</p>
<p>1) 'Soft split' long contigs (&gt;20k): Anvi'o shows the generalized statistics for each contig (GC content, etc.). For long contigs these stats are calculated across split contigs (which remain grouped)
2) Identify and locate open reading frames in your contigs (using Prodigal)
3) Estimate Single Copy Gene content (using hmmer against defined gene sets for <a href="http://www.pnas.org/content/110/14/5540.full">bacteria</a> and <a href="https://www.nature.com/nature/journal/v499/n7459/full/nature12352.html">archaea</a>)
3) Calculate k-mer frequencies for the contigs in our assemblies</p>
<p>So, run the following command to generate the database:</p>
<pre><code>anvi-gen-contigs-database -f anvio-contigs.fa -o anvio-contigs.db
</code></pre>

<p>Then, run this command to perform the hmm search and identify single copy gene content:</p>
<pre><code>anvi-run-hmms -c anvio-contigs.db --num-threads 28
</code></pre>

<p>Now, we can layer on the coverge information from our two samples:</p>
<pre><code>for file in *.anvio.bam
do
    anvi-profile -i $file -c anvio-contigs.db -T 28

done
</code></pre>

<p>And finally, we run the merge step. This will pull all the information together and create a merged anvi'o profile. This step will also run <a href="https://github.com/BinPro/CONCOCT">CONCOCT</a> (<em>another</em> binning algorithm) that will identify bins in our data. Finally, this step calculates the hierarchical relationship betwewen our contigs based on a variety of parameters.</p>
<pre><code>anvi-merge *ANVIO_PROFILE/PROFILE.db -o MERGED-SAMPLES -c anvio-contigs.db --enforce-hierarchical-clustering
</code></pre>

<p>Now we can visualize our data!</p>
<pre><code>anvi-interactive -p MERGED-SAMPLES/PROFILE.db -c anvio-contigs.db
</code></pre>

<h2 id="identifying-and-refining-genome-bins">Identifying and refining genome bins</h2>
<p>First, let's summarize the bin information for our data. This will produce a series of text-based output files detailing some statistics on our genome bins:</p>
<pre><code>anvi-summarize -p MERGED-SAMPLES/PROFILE.db -c anvio-contigs.db -o SAMPLES-SUMMARY -C CONCOCT
</code></pre>

<p>Take a look at the output in <code>SAMPLES-SUMMARY</code>. What does it report?</p>
<p>Now you can visualize those data in the anvi'o style by simply adding the -C flag to the previous anvi-interactive command:</p>
<pre><code>anvi-interactive -p MERGED-SAMPLES/PROFILE.db -c anvio-contigs.db -C CONCOCT
</code></pre>

<p>Now, we can actually refine the genome bins using anvi'o. This allows us to use human intuition and pattern recognition to better identify contigs that should co-occur.</p>
<p>It is important that we make a copy of the original data so that we don't accidentally overwrite it. So make a copy of the directory:</p>
<pre><code>cp -avr SAMPLES-SUMMARY/ SAMPLES-SUMMARY-ORIGININAL/
</code></pre>

<p>Now, let's refine a bin! Let's start with Bin_4.</p>
<pre><code>anvi-refine -p MERGED-SAMPLES/PROFILE.db -c anvio-contigs.db -b Bin_4 -C CONCOCT
</code></pre>

<p>Finally, it is time to interact with the anvi'o interface. <a href="../files/interacting-with-anvio.pdf">Here</a> are some screenshots to help guide you in your quest.</p>
<hr />
<p>And of course a big thank you to <a href="http://merenlab.org/people/">Meren</a> for providing us with extra materials to help create this tutorial!</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="http://ivory.idyll.org/lab/">Lab for Data Intensive Biology</a> at UC Davis
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.e72fd936.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../search/main.js"></script>
      
    
    
      
    
  </body>
</html>